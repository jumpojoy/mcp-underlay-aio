export LC_ALL=C
export RECLASS_SYSTEM_BRANCH=refs/changes/28/4428/3
export SALT_FORMULAS_IRONIC_BRANCH=refs/changes/05/4105/14
export SALT_FORMULAS_NEUTRON_BRANCH=refs/changes/01/4401/6


git clone https://github.com/jumpojoy/mcp-underlay-aio /root/mcp-underlay-aio

bash /root/mcp-underlay-aio/scripts/aio-setup.sh

salt 'vsaienko-mk-all-01.local' state.apply salt
salt 'vsaienko-mk-all-01.local' state.apply linux
#salt 'vsaienko-mk-all-01.local' state.apply ntp,openssh

salt 'vsaienko-mk-all-01.local' state.apply memcached
salt 'vsaienko-mk-all-01.local' state.apply rabbitmq
salt 'vsaienko-mk-all-01.local' state.apply mysql

salt 'vsaienko-mk-all-01.local' state.apply keystone
salt 'vsaienko-mk-all-01.local' state.apply apache
salt 'vsaienko-mk-all-01.local' state.apply neutron
salt 'vsaienko-mk-all-01.local' state.apply ironic
salt 'vsaienko-mk-all-01.local' state.apply tftpd_hpa

salt 'vsaienko-mk-all-01.local' state.apply baremetal_simulator

source /root/keystonercv3
openstack baremetal node list
local_ip=$(hostname --ip-address)
cirros_md5=$(md5sum /var/www/httproot/cirros-0.3.5-x86_64-disk.img | awk '{print $1}')
port_id=$(openstack baremetal port list --node n1 -f value -c UUID)
port_address=$(openstack baremetal port list --node n1 -f value -c Address)
vif_id=$(openstack port create --mac-address $port_address --network baremetal-flat-network n1-port -f value -c id)
openstack baremetal port set $port_id --extra vif_port_id=$vif_id
openstack baremetal node set n1 --instance-info image_checksum=$cirros_md5
openstack baremetal node set n1 --instance-info image_source=http://$local_ip/cirros-0.3.5-x86_64-disk.img
openstack baremetal node deploy n1
